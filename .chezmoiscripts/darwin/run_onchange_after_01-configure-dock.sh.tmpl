#!/usr/bin/env bash

set -eufo pipefail

{{ template "script_header.tmpl" }}
{{ $machine := (fromYaml (includeTemplate "machine.yaml.tmpl" .)) -}}

if [[ -z "$(command -v dockutil)" ]]; then
  echo "dockutil is not installed"
  exit 1
fi

# $1 name of app
function getAppPath {
  local app_name="$1"
  local app_path=""
  
  mapfile -t results < <( "/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/Support/lsregister" -dump \
    | grep -o "/.*${app_name}.app" \
    | grep -v -E "Caches|TimeMachine|Temporary|/Volumes/${app_name}" \
    | uniq )
  
  for result in "${results[@]}"; do
    if [ "$(basename "$result" .app)" == "$app_name" ]; then
      app_path="$result"
      break
    fi
  done

  printf "$app_path"
}

# $1 name of app
# $2 position
function addApp {
  local app_name="$1"
  local position=${2:-end}
  
  msg_wait "Looking for application \"${app_name}\""
  local app_path="$(getAppPath "$app_name")"

  if [ -z "$app_path" ]; then
    msg_error "Application \"${app_name}\" was not found and cannot be added"
  else
    msg_ok "Found application \"${app_name}\": " nocr
    dockutil --no-restart \
      --add "${app_path}" \
      --label "${app_name}" \
      --section apps \
      --position $position
  fi
}

# $1 label
# $2 path to items
# $3 position
# $4 sort
# $5 display
# $6 view
function addOther {
  local label="$1"
  local path="$2"
  local position=${3:-end}
  local sort=$4
  local display=$5
  local view=$6

  msg_wait "Validating item \"${label}\""
  if [ -d "$path" ]; then
    msg_ok "Item \"${label}\" is valid: " nocr
    dockutil --no-restart \
      --add "$path" \
      --label "$label" \
      --section others \
      --position $position \
      --sort $sort \
      --display $display \
      --view $view
  else
    msg_error "Item \"${label}\" is invalid: path ${path} not found"
  fi
}

# $1 label
function removeItem {
  local label="$1"

  msg_wait "Looking for docked item with label \"${label}\""
  dockutil --find "${label}" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    msg_ok "Found item with label \"${label}\" in dock: " nocr
    dockutil --no-restart --remove "${app_name}"
    echo "Removed"
  else
    msg_warn "Item with label \"${label}\" not found in dock"
  fi
}

trap 'killall Dock' EXIT

echo "Clearing existing dock items ..."
dockutil --no-restart --remove all

echo "Processing application items ..."
{{ $dockData := default dict (get $machine "dock") -}}
{{ if (hasKey $dockData "apps") -}}
{{   $sortedApps := list }}
{{   range $label, $appData := get $dockData "apps" -}}
{{     if not (hasKey $appData "label") -}}
{{       $appData = set $appData "label" $label -}}
{{     end -}}
{{     $sortedApps = append $sortedApps $appData -}}
{{   end -}}
{{   $sortedApps = $sortedApps | jq "sort_by(.position) | .[]" }}
{{   range $_, $appData := $sortedApps -}}
{{     if gt $appData.position 0 -}}
addApp "{{ $appData.label }}" {{ $appData.position }}
{{     else -}}
removeItem "{{ $appData.label }}"
{{     end -}}
{{   end -}}
{{ end -}}

echo "Processing other items ..."
{{ if (hasKey $dockData "others") -}}
{{   $sortedOthers := list }}
{{   range $label, $otherData := get $dockData "others" -}}
{{     if not (hasKey $otherData "label") -}}
{{       $otherData = set $otherData "label" $label -}}
{{     end -}}
{{     $sortedOthers = append $sortedOthers $otherData -}}
{{   end -}}
{{   $sortedOthers = $sortedOthers | jq "sort_by(.position) | .[]" }}
{{   range $_, $otherData := $sortedOthers -}}
{{     if gt $otherData.position 0 -}}
addOther "{{ $otherData.label }}" "{{ $otherData.path }}" {{ $otherData.position }} {{ $otherData.sort }} {{ $otherData.display }} {{ $otherData.view }}
{{     else -}}
removeItem "{{ $otherData.label }}"
{{     end -}}
{{   end -}}
{{ end }}

{{ template "script_footer.tmpl" }}