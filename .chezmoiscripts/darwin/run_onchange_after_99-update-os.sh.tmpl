#!/usr/bin/env bash

set -e

{{ template "script_header.tmpl" }}

echo "Checking for OS updates ..."
OLD_IFS="$IFS"
IFS=$'\n'
available=(
    $(softwareupdate --list --product-types macOS,Safari 2> /dev/null | grep "* Label"  | cut -d ' ' -f 3-)
)

echo "There are ${#available[@]} updates to install."
echo ""

if [ "${#available[@]}" -gt 0 ]; then
    echo "Downloading udpates ..."
    for update in "${available[@]}"; do
        softwareupdate --verbose --download "${update}"
        echo ""
    done

    while true; do
        read -p "Install updates and restart now (y/n)?" yn
        case $yn in
            [Yy]*) break ;;
            [Nn]*) clear; exit ;;
            *) echo "Please answer (y)es or (n)o." ;;
        esac
    done
    echo "Installing updates ..."
    sudo softwareupdate --no-scan --install --product-types macOS,Safari --restart --agree-to-license
fi
sIFSIFS=$OLD_IFS
{{ template "script_footer.tmpl" }}